{% extends 'ledger/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Expense Analysis{% endblock %}

{% block content %}
<div class="container py-3">

  <h5 class="mb-3">
    <i class="fas fa-chart-line me-2"></i> Expense Analysis
  </h5>

  <!-- Filters -->
  <form method="post" class="row g-3 mb-4">
    {% csrf_token %}

    <div class="col-md-2">
      <label class="form-label">Year</label>
      <select name="year" class="form-select">
        {% for y in available_years %}
          <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Month</label>
      <select name="month" class="form-select">
        {% for m, name in month_choices %}
          <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Category</label>
      <select name="category" class="form-select">
        <option value="all">All</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if selected_category == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3 align-self-end">
      <button class="btn btn-primary">Apply</button>
      <a href="{% url 'test' %}" class="btn btn-outline-secondary ms-1">Reset</a>
      <a href="{% url 'export_expenses' %}?year={{ selected_year }}&amp;month={{ selected_month }}&amp;category={{ selected_category }}" class="btn btn-outline-success ms-1" title="Download CSV">
        <i class="fas fa-download"></i>
      </a>
    </div>
  </form>

  <!-- Charts -->
  <div class="charts-row">
    <div class="chart-card">
      <h6 class="chart-title">Expenses by Subcategory</h6>
      <canvas id="barChart"></canvas>
    </div>

    <div class="chart-card">
      <h6 class="chart-title">Expenses by Category</h6>
      <canvas id="pieChart"></canvas>
    </div>
  </div>

</div>

<!-- ===================== STYLES ===================== -->
<style>
.charts-row {
  display: grid;
  grid-template-columns: 2.2fr 1fr;
  gap: 20px;
  align-items: stretch;
}

.chart-card {
  background: #ffffff;
  padding: 14px 16px 20px;
  border-radius: 8px;
  height: 460px;                 /* ‚úÖ controls white background */
  box-shadow: 0 1px 4px rgba(0,0,0,.08);
  display: flex;
  flex-direction: column;
}

.chart-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 6px;
  text-align: center;
}

.chart-card canvas {
  width: 100% !important;
  /* ‚ùå DO NOT set height here */
}
</style>

<!-- ===================== SCRIPTS ===================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const barLabels = JSON.parse('{{ labels_json|escapejs }}');
  const barValues = JSON.parse('{{ values_json|escapejs }}');
  const pieLabels = JSON.parse('{{ category_labels_json|escapejs }}');
  const pieValues = JSON.parse('{{ category_values_json|escapejs }}');

  // Decide orientation automatically
  const useHorizontal = barLabels.length > 8;

  // ---------- BAR CHART ----------
  new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: {
      labels: barLabels,
      datasets: [{
        label: "Amount (‚Çπ)",
        data: barValues,
        backgroundColor: "rgba(54, 162, 235, 0.6)",
        borderColor: "rgba(54, 162, 235, 1)",
        borderWidth: 1.5,
        maxBarThickness: 40
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,        // üî• IMPORTANT
      indexAxis: useHorizontal ? 'y' : 'x',
      layout: {
        padding: {
          bottom: useHorizontal ? 10 : 40,
          right: useHorizontal ? 20 : 10
        }
      },
      scales: {
        x: {
          ticks: {
            autoSkip: false,
            maxRotation: 45,
            minRotation: 30
          },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0,0,0,0.08)' }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `‚Çπ${ctx.parsed[useHorizontal ? 'x' : 'y'].toLocaleString('en-IN')}`
          }
        }
      }
    }
  });

  // ---------- PIE CHART ----------
  new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: {
      labels: pieLabels,
      datasets: [{
        data: pieValues,
        backgroundColor: [
          '#36A2EB','#FF6384','#FF9F40','#FFCD56','#4BC0C0','#9966FF'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            boxWidth: 12,
            font: { size: 11 }
          }
        }
      }
    }
  });
</script>

{% endblock %}