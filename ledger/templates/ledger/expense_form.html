
{% extends 'ledger/base.html' %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Add{% endif %} Expense - Expense Tracker{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h4 class="mb-0">{% if form.instance.pk %}Edit{% else %}Add{% endif %} Expense</h4>
      </div>
      <div class="card-body">
        <form method="post" action="">
          {% csrf_token %}

          <div class="mb-3">
            <label for="{{ form.amount.id_for_label }}" class="form-label">Amount *</label>
            {{ form.amount }}
            {% if form.amount.errors %}
              <div class="text-danger">{{ form.amount.errors }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label for="{{ form.category.id_for_label }}" class="form-label">Category *</label>
            {{ form.category }}
            {% if form.category.errors %}
              <div class="text-danger">{{ form.category.errors }}</div>
            {% endif %}
            <div class="form-text">
              Don't see your category? <a href="{% url 'category_create' %}">Add one</a>
            </div>
          </div>

          <div class="mb-3">
            <label for="{{ form.subcategory.id_for_label }}" class="form-label">Subcategory (optional)</label>
            {{ form.subcategory }}
            {% if form.subcategory.errors %}
              <div class="text-danger">{{ form.subcategory.errors }}</div>
            {% endif %}
            <div class="form-text">
              Don't see your subcategory? <a href="{% url 'subcategory_create' %}">Add one</a>
            </div>
          </div>

          <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
            {{ form.description }}
            {% if form.description.errors %}
              <div class="text-danger">{{ form.description.errors }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label for="{{ form.date.id_for_label }}" class="form-label">Date *</label>
            {{ form.date }}
            {% if form.date.errors %}
              <div class="text-danger">{{ form.date.errors }}</div>
            {% endif %}
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              {% if form.instance.pk %}Update{% else %}Add{% endif %} Expense
            </button>
            <a href="{% url 'expense_list' %}" class="btn btn-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{# Safely embed the subcategory->category map for JavaScript #}
{{ subcategory_category_map|json_script:"subcatCategoryMap" }}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const categorySelect = document.getElementById('id_category');
    const subcategorySelect = document.getElementById('id_subcategory');
    if (!categorySelect || !subcategorySelect) return;

    // Parse the safe JSON emitted by Django
    const subcategoryCategoryMap = JSON.parse(
      document.getElementById('subcatCategoryMap').textContent
    );

    // Clone all original options from the subcategory select
    const originalOptions = Array.from(subcategorySelect.options);

    const normalize = (v) => String(v ?? '');

    function refreshSubcategories() {
      const selectedCategoryId = normalize(categorySelect.value);

      // Reset subcategory select to placeholder
      subcategorySelect.innerHTML = '<option value="">---------</option>';

      if (selectedCategoryId) {
        // Show only subcategories that belong to the selected category
        for (const opt of originalOptions) {
          if (!opt.value) continue;
          const subcatId = normalize(opt.value);
          const mappedCategoryId = normalize(subcategoryCategoryMap[subcatId]);
          if (mappedCategoryId === selectedCategoryId) {
            subcategorySelect.appendChild(opt.cloneNode(true));
          }
        }
      } else {
        // No category selected -> show all subcategories
        for (const opt of originalOptions) {
          if (!opt.value) continue;
          subcategorySelect.appendChild(opt.cloneNode(true));
        }
      }

      // If selected subcategory is no longer visible, clear it
      const currentValue = subcategorySelect.value;
      if (currentValue) {
        const stillExists = Array.from(subcategorySelect.options)
          .some(o => o.value === currentValue);
        if (!stillExists) subcategorySelect.value = '';
      }
    }

    // Bind and initialize
    categorySelect.addEventListener('change', refreshSubcategories);
    refreshSubcategories();
  });
</script>
{% endblock %}